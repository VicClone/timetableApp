# НОВАЯ ВЕРСИЯ

LECTURE = 'lecture'
PRACTICE = 'practice'
LABORATORY = 'laboratory'
TYPE_LESSON = (LECTURE, PRACTICE, LABORATORY)
DAY_WEEK = ('пн', 'вт', 'ср', 'чт', 'пт')
TIMES = ('8:00', '9:00', '10:00', '11:00', '12:00')

d1 = {
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
d2 ={
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
room1 = {
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
room2 = {
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
room3 = {
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
room4 = {
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
room5 = {
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
room6 = {
    'пн': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'вт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'ср': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'чт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
    'пт': {
        '8:00': False,
        '9:00': False,
        '10:00': False,
        '11:00': False,
        '12:00': False
    },
}
import random


# def _create_timetable():
#     random.seed()
#     res = {}
#     count = random.randrange(1, 5)
#     for i in range(0, count):
#         day = random.choice(DAY_WEEK)
#         count2 = random.randrange(1, 9)
#         for i in range(0, count2):
#             time = random.choice(TIMES)
#             res[day] = {time: False}
#     return res


def do_clear_dict(dict_):
    """
    очищает словарь он пар где значение пусто

    Args:
        dict_ (dict): очищаемый словарь

    Returns:
        dict

    """
    dict_ = dict_.copy()
    del_key = []
    for k, v in dict_.items():
        if not v:
            del_key.append(k)
    for key in del_key:
        dict_.pop(key)

    return dict_


class _Name:
    def __init__(self, name):
        self.name = name

    def __repr__(self):
        return self.name


class Lesson(_Name):
    def __init__(self, name, types=(), is_type=None):
        super().__init__(name)
        if not types and not is_type:
            raise Exception()
        self._check(types)
        self.types = types
        self.is_type = is_type

    @staticmethod
    def _check(types):
        for _type in types:
            if _type not in TYPE_LESSON:
                raise ValueError('Тип {} не входит в {}'.format(_type, TYPE_LESSON))


class Calendar:
    def __init__(self, data=None):
        """

        Args:
            data (dict): расписание, если нет значеня - занят - {
                "пн": {
                    "9:00": obj - какой-то объект, если занят
                    ...
                }
                ....
            }
        """
        self.data = data

    def __repr__(self):
        tmp = '{}\n'
        tmp2 = '{}:\n'
        day_array = []
        for day, time_table in self.data.items():
            _day = tmp2.format(day)
            day_array.append(_day)
            for time, data in time_table.items():
                if data:
                    day_array.append(
                        tmp.format(
                            '{}: {}'.format(
                                time,
                               ', '.join([str(_data) for _data in (data or [])])
                            )
                        )
                    )

        return ''.join(day_array)
        # return str(id(self))

    def check(self, day, time):
        return not bool(self.data.get(day, {}).get(time))

    def fill(self, day, time, obj=True):
        """
        Заполнить

        Args:
            day (str): день недели
            time (str): время
            obj (object): какая-то информация

        Returns:
            bool: True - успех, иначе False
        """
        if not self.check(day, time):
            return False

        time_table = self.data.get(day, {})
        time_table[time] = obj
        self.data[day] = time_table

        return True

    def get_free_time(self, day):
        return {k for k, v in self.data.get(day, {}).items() if not v}

    def get_not_free_time(self, day):
        return {k for k, v in self.data.get(day, {}).items() if v}

    def copy(self):
        res = {}
        for k, v in self.data.items():
            _k = k.copy() if hasattr(k, 'copy') else k
            _v = v.copy() if hasattr(v, 'copy') else v
            res[_k] = _v

        return Calendar(res)


class _NameTimetable(_Name):
    def __init__(self, timetable, *args, **kwargs):
        """

        Args:
            timetable (Calendar): календарь
        """
        super().__init__(*args, **kwargs)
        self.timetable = timetable
        self._timetable = timetable.copy()

    def back_to_begin(self):
        self.timetable = self._timetable.copy()


class Class(_NameTimetable):
    def __init__(self, count, workload, max_lsns_per_day, max_lsn_per_day, *args, **kwargs):
        """

        Args:
            name (str): название
            timetable (Calendar): расписание
            count (int): количество
            workload (dict): {предмет: количество в неделю}
            max_lsns_per_day (int): максимальное количество уроков в день
            max_lsn_per_day (int): максимальное количество одного урока в день
        """
        super().__init__(*args, **kwargs)
        self.count = count
        self.workload = workload
        self._workload = workload.copy()
        # max_lsns_per_day не может быть меньше чем max_lsn_per_day
        self.max_lsns_per_day = max_lsns_per_day
        self.max_lsn_per_day = max_lsn_per_day
        self._lesson_variant = []


    def check_day(self, day):
        """
        Проверяет не превышает ли количество поставленных уроков максимально заданному
        Args:
            day (str): день недели

        Returns:
            bool - True - меньше максимального, иначе False

        """
        count = 0
        for _, obj in self.timetable.data[day].items():
            if obj:
                count += 1
        return count < self.max_lsns_per_day

    def back_to_begin(self):
        super().back_to_begin()
        self._workload = self.workload.copy()

    def get_lesson(self, exclude=()):
        res_less = set(self._lesson_variant) - set(exclude)
        if not res_less:
            _v = -1
            clear_dict = do_clear_dict(self._workload) or {}
            for k, v in clear_dict.items():
                if v > _v and k not in exclude:
                    _v = v

            lesson_variant= []
            for k, v in clear_dict.items():
                if v == _v:
                    lesson_variant.append(k)
            self._lesson_variant = lesson_variant

        if self._lesson_variant:
            return random.choice(self._lesson_variant)

        return None

    def get_using_workload(self):
        return self._workload

    def choice_lesson(self, lesson):
        self._lesson_variant.remove(lesson)
        self._workload[lesson] -= 1


class Teacher(_NameTimetable):
    def __init__(self, lesson, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.lesson = lesson

    def check_lesson(self, lesson):
        """

        Args:
            lesson (Lesson): урок

        Returns:
            bool: True если подходит, False иначе

        """
        #TODO можно сдеать сравнение на уровне Lesson
        return self.lesson.name == lesson.name and lesson.is_type in self.lesson.types


class Room(_NameTimetable):
    def __init__(self, types, capacity, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.types = types
        self.capacity = capacity


class Rooms:
    def __init__(self, rooms):
        """

        Args:
            rooms (list of Room): список кабинетов
        """
        self.rooms = rooms

    def find_free(self, day, time, capacity):
      random.seed()
      count = random.randrange(0,len(self.rooms))
      for i in range(0, count):
        room = random.choice(self.rooms)
        if room.capacity >= capacity:
            not_free_time = room.timetable.get_not_free_time(day)
            if time not in not_free_time:
                return room


class Teachers:
    def __init__(self, teachers):
        """

        Args:
            teachers (list of Teacher): список учителей
        """
        self.teachers = teachers

    def find_free(self, day, time, lesson):
        """
        Ищет свободного учителя в определённый день, время и на определённый предмет
        TODO если 2 урока должны идти подряд, то это можно учесть здесь
        Args:
            day (str): день недели
            time (str): время
            lesson (Lesson): предмет

        Returns:
            Teacher

        """
        for teacher in self.teachers:
            if teacher.check_lesson(lesson):
                free_time = teacher.timetable.get_free_time(day)
                if time in free_time:
                    return teacher


class TimetableCreator:
    def __init__(self, rooms, teachers, classes, repeat_count=1):
        """

        Args:
            rooms (Rooms): список аудиторий
            teachers (Teachers): список учителей
            classes (list of Class): список групп
            timetable (Calendar): заполняемы календарь
        """
        self.rooms = rooms
        self.teachers = teachers
        self.classes = classes
        self.repeat_count = repeat_count

    def create(self):
        count = self.repeat_count
        while count != 0:
            self._create()
            all_right = True
            for class_ in self.classes:
                if not do_clear_dict(class_.get_using_workload()):
                    count -= 1
                    self.back_to_begin()
                    all_right = False
                    break

            if all_right:
                break

        # Если не получилось заполнить расписание так чтобы у всех были проставленый все уроки,
        # то заполним расписание хотя бы как-нибуль
        else:
            self._create()

    def _create(self):
        for class_ in self.classes:
            for day in DAY_WEEK:
                lesson2count = {}
                exclude = lambda x, y: [key for key, v in x.items() if v >= y.max_lsn_per_day]
                while True:
                    lesson = class_.get_lesson(exclude(lesson2count, class_))
                    if not lesson:
                        break
                    free_time = class_.timetable.get_free_time(day)
                    for time in free_time:
                        room = self.rooms.find_free(day, time, class_.count)
                        teacher = self.teachers.find_free(day, time, lesson)
                        if room and teacher:
                            class_.choice_lesson(lesson)
                            lesson2count[lesson] = lesson2count.get(lesson, 0) + 1
                            self.fill(day, time, teacher, lesson, class_, room)
                            # добавили в расписание текущий урок, прерываем цикл по поиску времени
                            break

                    # если мы прошли весь цикл проверки куда можно опставить урок и ничего не нашли на этот день,
                    # укажем что на сегодня он полностью заполнен, чтобы его больше не получать
                    else:
                        lesson2count[lesson] = class_.max_lsn_per_day

                    if not class_.check_day(day):
                        break
                if not class_.check_day(day):
                    continue

    def back_to_begin(self):
        for items in (self.classes, self.rooms.rooms, self.teachers.teachers):
           for item in items:
               item.back_to_begin()

    @staticmethod
    def fill(day, time, teacher, lesson, _class, room):
        """
        Args:
            day (str): день
            time (str): время
            teacher (Teacher): преподаватель
            lesson (Lesson): предмет
            _class (Class): класс
            room (Room): кабинет

        """
        _class.timetable.fill(day, time, (teacher, lesson, room))
        teacher.timetable.fill(day, time, (_class, lesson, room))
        room.timetable.fill(day, time, (teacher, _class, lesson))


if __name__ == '__main__':
    lesson = Lesson('физика', [LECTURE, PRACTICE])
    lesson2 = Lesson('русский', [LECTURE, PRACTICE])
    lesson3 = Lesson('химия(лекц)', [LECTURE])
    lesson4 = Lesson('математика', [LECTURE])
    lesson5 = Lesson('химия(практ)', [LECTURE])
    lesson6 = Lesson('биология', [LECTURE])
    teacher_1 = {
        'пн': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'вт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'ср': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'чт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'пт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
    }
    teacher_2 = {
        'пн': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'вт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'ср': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'чт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'пт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
    }
    teacher_3 = {
        'пн': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'вт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'ср': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'чт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'пт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
    }
    teacher_4 = {
        'пн': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'вт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'ср': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'чт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'пт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
    }
    teacher_5 = {
        'пн': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'вт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'ср': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'чт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'пт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
    }
    teacher_6 = {
        'пн': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'вт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'ср': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'чт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
        'пт': {
            '8:00': False,
            '9:00': False,
            '10:00': False,
            '11:00': False,
            '12:00': False
        },
    }
    teachers = []
    teachers.append(Teacher(name='Петров И.Г.', lesson=lesson, timetable=Calendar(teacher_1)))
    teachers.append(Teacher(name='Пупкина А.П.', lesson=lesson2, timetable=Calendar(teacher_2)))
    teachers.append(Teacher(name='Иванов И.П.', lesson=lesson3, timetable=Calendar(teacher_3)))
    teachers.append(Teacher(name='Филиппова М.А.', lesson=lesson4, timetable=Calendar(teacher_4)))
    teachers.append(Teacher(name='Лещева И.П.', lesson=lesson5, timetable=Calendar(teacher_5)))
    teachers.append(Teacher(name='Калинин С.М.', lesson=lesson6, timetable=Calendar(teacher_6)))
    teachers = Teachers(teachers)
    _class = Class(
        name='5а',
        count=4,
        timetable=Calendar(d1),
        workload={
            Lesson(name='физика', is_type=LECTURE): 3,
            Lesson(name='химия(лекц)', is_type=LECTURE): 3,
            Lesson(name='химия(практ)', is_type=LECTURE): 3,
            Lesson(name='русский', is_type=LECTURE): 5,
            Lesson(name='биология', is_type=LECTURE): 3,
            Lesson(name='математика', is_type=LECTURE):3

        },
        max_lsns_per_day=5,
        max_lsn_per_day=2,
    )

    _class2 = Class(
        name='5б',
        count=4,
        timetable=Calendar(d2),
        workload={
            Lesson(name='физика', is_type=LECTURE): 3,
            Lesson(name='химия(лекц)', is_type=LECTURE): 3,
            Lesson(name='химия(практ)', is_type=LECTURE): 3,
            Lesson(name='русский', is_type=LECTURE): 5,
            Lesson(name='биология', is_type=LECTURE): 3,
            Lesson(name='математика', is_type=LECTURE):3
        },
        max_lsns_per_day=5,
        max_lsn_per_day=2,
    )
    rooms = []
    rooms.append(Room(TYPE_LESSON, 40, name='R205', timetable=Calendar(room1))) #_create_timetable()
    rooms.append(Room(TYPE_LESSON, 50, name='102', timetable=Calendar(room2)))
    rooms.append(Room(TYPE_LESSON, 40, name='103', timetable=Calendar(room3)))
    rooms.append(Room(TYPE_LESSON, 40, name='104', timetable=Calendar(room4)))
    rooms.append(Room(TYPE_LESSON, 30, name='105', timetable=Calendar(room5)))
    rooms.append(Room(TYPE_LESSON, 40, name='Т405', timetable=Calendar(room6)))
    rooms = Rooms(rooms)

    classes = [
        _class,
        _class2,
        # _class3
    ]

    creator = TimetableCreator(rooms, teachers, classes)
    creator.create()
    for _class_ in classes:
        print(_class_.name, _class_.timetable)
        # print(type(_class_.timetable.data.get("пн").get("8:00")[0]))
    
    correct_ = []
    wrong_positions = []
    for _class_ in classes:
      lesson_sum = 0
      for day_of_the_week in _class_.timetable.data.values():
        for i in day_of_the_week:
          if day_of_the_week.get(i) is not False:
            lesson_sum += 1
      if sum(_class_.workload.values())!=lesson_sum:
        correct_.append(0)
        wrong_positions.append(_class_.name)
      else:
        correct_.append(1)

    if False in correct_:
      print("Расписание составлено некорректно для " + str(wrong_positions)  + ". Попробуйте изменить условия или скорректируйте его вручную.")